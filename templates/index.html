<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <title>DFA Simulator</title>

  <!-- main stylesheet -->
  <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}"/>

  <!-- FontAwesome -->
  <script src="https://kit.fontawesome.com/your-kit.js" crossorigin="anonymous"></script>

  <!-- Cytoscape core -->
  <script src="https://unpkg.com/cytoscape/dist/cytoscape.min.js"></script>
  <!-- Dagre core & bridge -->
  <script src="https://unpkg.com/dagre@0.8.5/dist/dagre.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/cytoscape-dagre@2.5.0/cytoscape-dagre.js"></script>

  <style>
    .hidden  { display: none !important; }
    .visible { display: block !important; }
    #cy { width:100%; height:80vh; }
  </style>
</head>
<body data-theme="{{ 'dark' if request.cookies.get('theme')=='dark' else 'light' }}">
  <aside>
    <div class="header">
      <div class="logo-container">
        <div class="logo"><i class="fas fa-project-diagram"></i></div>
        <h1>DFA Simulator</h1>
      </div>
      <button id="mode-toggle" class="toggle-mode"><i class="fas fa-moon"></i></button>
    </div>

    <div class="control-group">
      <label for="regex-select">Language Type</label>
      <select id="regex-select">
        <option value="" disabled selected>-- choose --</option>
        <option value="binary">Binary Pattern</option>
        <option value="alphabet">Alphabet Pattern</option>
      </select>
    </div>

    <div class="control-group">
      <label for="input-string">Input String</label>
      <input id="input-string" type="text" placeholder="Enter a string..." disabled/>
    </div>

    <div class="button-group" style="display:flex; gap:.5rem;">
      <button id="simulate-btn" disabled><i class="fas fa-play"></i> Simulate DFA</button>
      <button id="reset-btn"><i class="fas fa-undo"></i> Reset</button>
    </div>

    <div id="result" class="result-empty">Waiting for simulation...</div>
  </aside>

  <main>
    <div id="regex-card" class="card hidden">
      <h2><i class="fas fa-code"></i> Regular Expression</h2>
      <div id="regex-display" class="placeholder"></div>
    </div>

    <div id="cy-card" class="card hidden">
      <h2><i class="fas fa-project-diagram"></i> DFA Visualization</h2>
      <div id="cy"></div>
    </div>

    <div class="grid">
      <div class="card">
        <h2><i class="fas fa-server"></i> PDA Description</h2>
        <div class="placeholder" id="pda-placeholder"></div>
      </div>
      <div class="card">
        <h2><i class="fas fa-sitemap"></i> Context‚ÄêFree Grammar</h2>
        <div class="placeholder" id="cfg-placeholder"></div>
      </div>
    </div>
  </main>

  <script>
  document.addEventListener('DOMContentLoaded', () => {
    cytoscape.use(cytoscapeDagre);

    // timing constants for slower pace
    const STEP_DELAY     = 400;
    const ANIM_DURATION  = 300;
    const RESET_DURATION = 150;

    // UI refs
    const select       = document.getElementById('regex-select');
    const regexCard    = document.getElementById('regex-card');
    const regexDisplay = document.getElementById('regex-display');
    const cyCard       = document.getElementById('cy-card');
    const inputBox     = document.getElementById('input-string');
    const simulateBtn  = document.getElementById('simulate-btn');
    const resetBtn     = document.getElementById('reset-btn');
    const resultDiv    = document.getElementById('result');

    // regex presets
    const defaultRegexMap = {
      binary: `(111+000+101+001) (1+0)* (11+00)(11+00)* (101+111+000) (101+111+000)* (11+00) (1+0+11) (11*) (00*) (1*+0*+1+0) (1+0)*`,
      alphabet: `(ab+ba) (ab+ba)* (aaa+bbb+aba) (a+b)* (bb*) (aa*) (a+b) (aa+bb) (a+b)* (bb+aa+aba+bab) (bb+aa+aba+bab)*`
    };

    // color for highlights
    const accentColor = getComputedStyle(document.documentElement)
      .getPropertyValue('--accent').trim();

    // two DFAs
    const TRANSITIONS = {
      binary: {
        q0:{0:'q2',1:'q1'}, q1:{0:'q3',1:'q3'},
        q2:{0:'q4',1:'T1'},q3:{0:'T2',1:'q5'},
        q4:{0:'q5',1:'q5'},q5:{0:'q7',1:'q6'},
        q6:{0:'q7',1:'q8'},q7:{0:'q8',1:'q6'},
        q8:{0:'q10',1:'q9'},q9:{0:'q11',1:'q12'},
        q10:{0:'q13',1:'q5'},q11:{0:'q8',1:'q14'},
        q12:{0:'q10',1:'q14'},q13:{0:'q14',1:'q9'},
        q14:{0:'q16',1:'q15'},q15:{0:'q16',1:'q17'},
        q16:{0:'q17',1:'q15'},q17:{0:'q19',1:'q18'},
        q18:{0:'q15',1:'q20'},q19:{0:'q20',1:'q17'},
        q20:{0:'q21',1:'q20'},q21:{0:'q21',1:'q21'},
        T1:{0:'T1',1:'T1'},T2:{0:'T2',1:'T2'}
      },
      alphabet: {
        q0:{a:'q1',b:'q2'},q1:{a:'T1',b:'q3'},
        q2:{a:'q3',b:'T2'},q3:{a:'q4',b:'q5'},
        q4:{a:'q6',b:'q7'},q5:{a:'q3',b:'q8'},
        q6:{a:'q9',b:'q3'},q7:{a:'q9',b:'q3'},
        q8:{a:'q3',b:'q9'},q9:{a:'q9',b:'q10'},
        q10:{a:'q11',b:'q10'},q11:{a:'q12',b:'q12'},
        q12:{a:'q13',b:'q14'},q13:{a:'q15',b:'q12'},
        q14:{a:'q12',b:'q15'},q15:{a:'q16',b:'q17'},
        q16:{a:'q21',b:'q18'},q17:{a:'q19',b:'q20'},
        q18:{a:'q21',b:'q17'},q19:{a:'q16',b:'q20'},
        q20:{a:'q16',b:'q17'},q21:{a:'q11',b:'q17'},
        T1:{a:'T1',b:'T1'},T2:{a:'T2',b:'T2'}
      }
    };

    const ACCEPT_MAP = {
      binary: ['q21'],
      alphabet: ['q20', 'q21']
    }

    function buildElements(transitions, acceptStates = []) {
      const states = Object.keys(transitions);
      const START  = 'q0';
      const ACCEPT = new Set(acceptStates);

      const nodes = states.map(s => ({
        data: { id: s },
        classes: s===START ? 'start' : (ACCEPT.has(s) ? 'accept' : '')
      }));

      const edges = states.flatMap(src =>
        Object.entries(transitions[src]).map(([sym,dst]) => ({
          data: {
            id:     `${src}_${sym}_${dst}`,
            source: src,
            target: dst,
            label:  sym
          }
        }))
      );

      return [...nodes, ...edges];
    }

    // CSS NG GRAPH
    const cy = cytoscape({
      container: document.getElementById('cy'),
      elements: [],
      style: [
        { selector:'node', style:{ label:'data(id)', 'text-valign':'center', 'text-halign':'center', 'background-color':'#444', 'color':'#fff', width:40, height:40, 'border-width':2, 'border-color':'#222' }},
        { selector:'node.start', style:{ 'border-color':'#48bb78','border-width':4 }},
        { selector:'node.accept', style:{ shape:'doublecircle','border-color':'#e53e3e','border-width':4 }},
        { selector:'edge', style:{ 'curve-style':'bezier','target-arrow-shape':'triangle', label:'data(label)','font-size':20, 'line-color':'#888','target-arrow-color':'#888' }},
        { selector:'.highlighted', style:{ 'background-color':accentColor,'line-color':accentColor,'target-arrow-color':accentColor }}
      ],
      layout:{ name:'dagre', rankDir:'LR', nodeSep:50, edgeSep:10, rankSep:100, padding:20 }
    });

    // DFA simulation
    function simulateDFA(input) {
      cy.elements().removeClass('highlighted');
      let cur = 'q0';
      cy.getElementById(cur).addClass('highlighted');

      input.split('').reduce((p, ch) =>
        p.then(() => new Promise(resolve => {
          const transTable = TRANSITIONS[ select.value ];
          const next = (transTable[cur] && transTable[cur][ch]) || 'T';
          const edge = cy.getElementById(`${cur}_${ch}_${next}`);
          const node = cy.getElementById(next);

          edge.style({ 'line-color':accentColor,'target-arrow-color':accentColor });
          node.animate({ style:{ 'background-color': accentColor } }, { duration: ANIM_DURATION });

          setTimeout(() => {
            edge.style({ 'line-color':'#888','target-arrow-color':'#888' });
            cur = next;
            resolve();
          }, ANIM_DURATION);
        })).then(() => new Promise(r => setTimeout(r, STEP_DELAY)))
      , Promise.resolve())
      .then(() => {
        setTimeout(() => {
          const mode = select.value;
          const ok = ACCEPT_MAP[mode].includes(cur);
          resultDiv.textContent = ok ? 'ACCEPTED' : 'REJECTED';
          resultDiv.className = ok ? 'valid' : 'invalid';
        }, RESET_DURATION);
      });
    }

    // UI toggle + graph rebuild
    function updateUI(){
      if(select.value === 'binary' || select.value === 'alphabet'){
        regexDisplay.textContent = defaultRegexMap[select.value];
        regexCard.classList.replace('hidden','visible');
        cyCard  .classList.replace('hidden','visible');
        inputBox.disabled    = false;
        simulateBtn.disabled = false;
        resultDiv.textContent = 'Waiting for simulation...';
        resultDiv.className   = 'result-empty';

        const mode = select.value;
        const table = TRANSITIONS[mode];
        const acceptStates = ACCEPT_MAP[mode];
        const newElements = buildElements(table, acceptStates);
        
        cy.json({ elements: newElements });
        cy.layout({ name:'dagre', rankDir:'LR', nodeSep:50, edgeSep:10, rankSep:100, padding:20 }).run();
      } else {
        regexCard.classList.replace('visible','hidden');
        cyCard  .classList.replace('visible','hidden');
        inputBox.disabled    = true;
        simulateBtn.disabled = true;
      }
    }
    select.addEventListener('change', updateUI);

    // simulation & reset
    simulateBtn.addEventListener('click', ()=>{
      const str = inputBox.value.trim();
      if(str) simulateDFA(str);
    });
    resetBtn.addEventListener('click', ()=>location.reload());

    // theme toggle
    document.getElementById('mode-toggle').addEventListener('click', ()=>{
      const root = document.documentElement;
      const next = root.getAttribute('data-theme')==='light'?'dark':'light';
      root.setAttribute('data-theme', next);
      document.cookie = `theme=${next};path=/;max-age=31536000`;
    });
  });
  </script>
</body>
</html>
